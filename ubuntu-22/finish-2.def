Bootstrap: localimage
From: {{base}}

%post

BASE=/opt/patric-common
RT=$BASE/runtime

if [[ ! -d $RT ]] ; then
   echo "Missing runtime (bad source image?)" 1>&2
   exit 1
fi

bash -c "export PATH=/opt/patric-common/runtime/bin:$PATH; cpanm Bio::Tools::Run::Alignment::Clustalw"

BUILD_BASE=/runtime_build
BUILD_MODS=$BUILD_BASE/runtime-modules
cd $BUILD_BASE
git checkout master
git pull

cd $BUILD_MODS/p3_redis
./build.package /opt/patric-common/runtime

/opt/patric-common/runtime/bin/pip3 install redis

mkdir -p $BASE/app-runtime/variation

export BUILD_TOOLS=$RT/build-tools

#
# Inline build
#

cd $BUILD_BASE
git clone --recursive https://github.com/PATRIC3/freebayes.git
cd freebayes
make
cp bin/freebayes bin/bamleftalign /opt/patric-common/app-runtime/variation/bin/
cp scripts/freebayes-parallel /opt/patric-common/app-runtime/variation/bin/freebayes-parallel
chmod +x /opt/patric-common/app-runtime/variation/bin/freebayes-parallel
